{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Kitchen Story Lab{% endblock %}

{% block content %}
<article class="container">
    <section class="row">
        <div class="col-lg-8">
            <!-- 상단 네비게이션 버튼 추가 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <a href="{% url 'blog:post_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-list me-1"></i>목록으로
                </a>
                {% if user == post.author %}
                <div>
                    <a href="{% url 'blog:post_update' post.pk %}" class="btn btn-outline-primary me-2">
                        <i class="bi bi-pencil me-1"></i>수정
                    </a>
                    <a href="{% url 'blog:post_delete' post.pk %}" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>삭제
                    </a>
                </div>
                {% endif %}
            </div>

            <article class="card shadow-sm mb-4">
                <div class="card-body">
                    <header class="mb-4">
                        <h1 class="card-title mb-3">{{ post.title }}</h1>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                {% if post.author.profile_image %}
                                    <img src="{{ post.author.profile_image.url }}" 
                                         class="rounded-circle me-2" width="32" height="32" alt="{{ post.author.username }}">
                                {% else %}
                                    <img src="{% static 'images/default-avatar.png' %}" 
                                         class="rounded-circle me-2" width="32" height="32" alt="{{ post.author.username }}">
                                {% endif %}
                                <span class="text-muted">{{ post.author.username }}</span>
                            </div>
                            <small class="text-muted">{{ post.created_at|date:"Y년 m월 d일" }}</small>
                        </div>
                    </header>
                    
                    <section class="mb-4">
                        {{ post.content|safe }}
                    </section>
                    
                    <!-- 레시피 정보 섹션 추가 -->
                    {% if recipe_detail %}
                    <section class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">레시피 정보</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% if recipe_detail.serving_size %}
                                <div class="col-md-4">
                                    <strong>분량</strong>
                                    <p>{{ recipe_detail.serving_size }}</p>
                                </div>
                                {% endif %}

                                {% if recipe_detail.cooking_time %}
                                <div class="col-md-4">
                                    <strong>조리 시간</strong>
                                    <p>{{ recipe_detail.cooking_time }}분</p>
                                </div>
                                {% endif %}

                                {% if recipe_detail.difficulty %}
                                <div class="col-md-4">
                                    <strong>난이도</strong>
                                    <p>
                                        {% if recipe_detail.difficulty == 'easy' %}초급
                                        {% elif recipe_detail.difficulty == 'medium' %}중급
                                        {% else %}고급
                                        {% endif %}
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </section>
                    {% endif %}

                    <footer class="d-flex justify-content-between align-items-center border-top pt-3">
                        <div>
                            <button class="btn btn-outline-primary like-button" data-post-id="{{post.pk}}">
                                <i class="bi bi-heart {% if is_liked %}text-danger{% endif %} me-1"></i>
                                <span class="like-count">{{ post.postlike_set.count }}</span>
                            </button>
                        </div>
                        <div>
                            <span class="me-3">
                                <i class="bi bi-eye me-1"></i>{{ post.view_count }}
                            </span>
                            {% if post.category %}
                                <span class="badge bg-primary">{{ post.category.name }}</span>
                            {% endif %}
                        </div>
                    </footer>
                </div>
            </article>

            <!-- 하단 네비게이션 버튼 -->
            <div class="d-flex justify-content-between mt-3">
                {% if previous_post %}
                <a href="{% url 'blog:post_detail' previous_post.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left me-1"></i>이전 글
                </a>
                {% endif %}

                {% if next_post %}
                <a href="{% url 'blog:post_detail' next_post.pk %}" class="btn btn-outline-secondary ms-auto">
                    다음 글<i class="bi bi-chevron-right ms-1"></i>
                </a>
                {% endif %}
            </div>

            <!-- 댓글 섹션 -->
<section class="mt-5">
    <h5 class="mb-4">댓글 {{ post.comments.count }}개</h5>
    
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'blog:comment_create' post.pk %}">
        {% csrf_token %}
        <div class="form-group">
            {{ comment_form.content }}
            <small class="text-muted">최대 500자까지 입력 가능합니다.</small>
        </div>
        <button type="submit" class="btn btn-primary mt-2">댓글 작성</button>
    </form>
    {% else %}
    <p>댓글을 작성하려면 <a href="{% url 'accounts:login' %}">로그인</a>해주세요.</p>
    {% endif %}
    
    <!-- 댓글 목록 -->
    <div class="comments mt-4">
        {% for comment in post.comments.all %}
        <div class="comment mb-3 border-bottom pb-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>{{ comment.author.username }}</strong>
                <small class="text-muted">{{ comment.created_at|date:"Y.m.d H:i" }}</small>
            </div>
            <p>{{ comment.content }}</p>
            
            {% if user == comment.author %}
            <div class="comment-actions">
                <a href="{% url 'blog:comment_update' comment.pk %}" class="btn btn-sm btn-outline-primary">수정</a>
                <a href="{% url 'blog:comment_delete' comment.pk %}" class="btn btn-sm btn-outline-danger">삭제</a>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p class="text-muted">아직 댓글이 없습니다.</p>
        {% endfor %}
    </div>
</section>
        </div>

        <!-- 사이드바 -->
        <aside class="col-lg-4">
            <!-- 관련 레시피 -->
            <section class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">관련 레시피</h5>
                </div>
                <div class="card-body">
                    {% for related_post in related_posts %}
                    <a href="{% url 'blog:post_detail' related_post.pk %}" 
                       class="d-flex align-items-center mb-3 text-decoration-none">
                        <div>
                            <h6 class="mb-1 text-dark">{{ related_post.title|truncatechars:30 }}</h6>
                            <small class="text-muted">{{ related_post.created_at|date:"Y-m-d" }}</small>
                        </div>
                    </a>
                    {% empty %}
                    <p class="text-muted text-center py-3">관련 레시피가 없습니다.</p>
                    {% endfor %}
                </div>
            </section>
        </aside>
    </section>
</article>
{% endblock %}
